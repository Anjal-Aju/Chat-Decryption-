<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Web - Vikram's Phone</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            wa: {
              bg: '#0c1317',        
              header: '#202c33',    
              sidebar: '#111b21',   
              incoming: '#202c33',  
              outgoing: '#005c4b',  
              primary: '#00a884',   
              text: '#e9edef',      
              textSec: '#8696a0',   
              border: '#2a3942',    
              input: '#2a3942',     
              system: '#182229',
            }
          }
        }
      }
    }
  </script>

  <style>
    body { 
        user-select: none; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: #0c1317;
        color: #e9edef;
        overflow: hidden;
        margin: 0;
        padding: 0;
    }
    
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background-color: rgba(134, 150, 160, 0.3); }

    .chat-bg {
        background-color: #0b141a;
        background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
        background-blend-mode: overlay;
        opacity: 0.95;
    }

    .tail-out { border-radius: 7.5px; border-top-right-radius: 0; }
    .tail-out::before {
        content: ""; position: absolute; top: 0; right: -8px; width: 0; height: 0;
        border: 8px solid transparent; border-top-color: #005c4b; border-right: 0; border-bottom: 0;
    }
    
    .tail-in { border-radius: 7.5px; border-top-left-radius: 0; }
    .tail-in::before {
        content: ""; position: absolute; top: 0; left: -8px; width: 0; height: 0;
        border: 8px solid transparent; border-top-color: #202c33; border-left: 0; border-bottom: 0;
    }

    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    .slide-in { animation: slideIn 0.3s cubic-bezier(0.1, 0.82, 0.25, 1) forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .fade-in { animation: fadeIn 0.2s ease-out; }

    /* Decryption Styles */
    .cipher-char {
        color: #fca5a5; /* Red/Pink for encrypted */
        font-family: 'Courier New', monospace;
        font-weight: bold;
        cursor: pointer;
        padding: 0 1px;
        transition: all 0.2s;
        border-bottom: 1px dotted #fca5a5;
    }
    .cipher-char:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #fff;
    }
    .cipher-char.locked {
        color: #ef4444; /* Darker red for locked */
        cursor: not-allowed;
        opacity: 0.6;
    }
    .solved-char {
        color: inherit; /* Normal text color */
        animation: fadeIn 0.5s ease-in;
    }
  </style>
</head>
<body class="h-screen w-full relative">

  <div id="start-overlay" class="fixed inset-0 z-[200] bg-wa-bg flex flex-col items-center justify-center text-white cursor-pointer transition-colors" onclick="enterGame()">
      <div class="mb-8 relative">
          <i class="fab fa-whatsapp text-6xl text-gray-500"></i>
          <div class="absolute -bottom-2 -right-2 bg-yellow-600 text-[10px] px-2 py-0.5 rounded font-bold tracking-wider">LOCKED</div>
      </div>
      <h1 class="text-2xl font-light mb-4 text-wa-text">Vikram's Phone</h1>
      <p class="text-wa-textSec text-sm mb-8 text-center max-w-md leading-relaxed">
          <span class="text-wa-primary font-bold tracking-wide">MISSION:</span><br>
          Use the <span class="text-white bg-wa-primary px-1 rounded">Decryption Solver</span> to read the chats.<br>
          <br>
          1. Find the Key.<br>
          2. Click any <span class="text-red-300 font-mono">RED LETTER</span> to solve it.<br>
          <span class="text-red-400 font-bold">WARNING:</span> Wrong guesses lock that letter for 1 minute.
      </p>
      <div class="px-8 py-2 border border-wa-primary rounded-full text-wa-primary font-medium hover:bg-wa-header transition tracking-wide text-sm">
          ENTER SYSTEM
      </div>
  </div>

  <div id="solver-modal" class="fixed inset-0 z-[180] bg-black/80 hidden flex items-center justify-center p-4 fade-in">
      <div class="bg-wa-header w-80 rounded-lg shadow-2xl border border-wa-border flex flex-col items-center p-6">
          <div class="text-wa-textSec text-xs uppercase tracking-widest mb-2">Decryption Tool</div>
          <div class="text-3xl text-wa-text mb-4 font-mono">
              <span class="text-red-400" id="solver-target">?</span> <i class="fas fa-arrow-right text-sm mx-2 text-wa-textSec"></i> <span class="text-wa-primary">?</span>
          </div>
          <input type="text" id="solver-input" maxlength="1" class="bg-wa-bg text-center text-2xl text-wa-text border-b-2 border-wa-primary w-16 mb-4 focus:outline-none uppercase" placeholder="?">
          <div id="solver-timer" class="hidden text-red-500 font-bold text-xl mb-4 font-mono">LOCKED: 60s</div>
          <div id="solver-msg" class="text-xs h-4 mb-4 text-center text-red-400"></div>
          <div class="flex gap-2 w-full">
              <button onclick="closeSolver()" class="flex-1 py-2 text-wa-textSec hover:bg-wa-incoming rounded text-sm">Cancel</button>
              <button id="solver-submit-btn" onclick="submitSolution()" class="flex-1 py-2 bg-wa-primary text-black font-bold rounded text-sm">Decrypt</button>
          </div>
      </div>
  </div>

  <div id="key-modal" class="fixed inset-0 z-[160] bg-black/80 hidden flex items-center justify-center p-4 fade-in">
      <div class="bg-wa-header w-full max-w-2xl rounded-lg shadow-2xl border border-wa-border flex flex-col max-h-[90vh]">
          <div class="p-4 border-b border-wa-border flex justify-between items-center shrink-0">
              <h2 class="text-xl text-wa-text font-medium flex items-center gap-2">
                  <i class="fas fa-key text-wa-primary"></i> Decryption Key
              </h2>
              <button onclick="closeKeyModal()" class="text-wa-textSec hover:text-wa-text w-8 h-8 flex items-center justify-center rounded-full hover:bg-wa-border transition">
                  <i class="fas fa-times text-lg"></i>
              </button>
          </div>
          <div class="p-6 bg-wa-sidebar overflow-y-auto">
              <div class="text-wa-textSec text-sm mb-4 text-center sticky top-0 bg-wa-sidebar pb-2 border-b border-wa-border">
                  SORTED BY: <span class="text-wa-primary font-bold">ENCRYPTED LETTER (A-Z)</span>
              </div>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 font-mono text-wa-text" id="key-content">
                  </div>
          </div>
      </div>
  </div>

  <div class="flex h-full w-full relative overflow-hidden bg-wa-bg">
    
    <div id="column-1" class="w-full md:w-[400px] lg:w-[450px] flex flex-col border-r border-wa-border bg-wa-sidebar h-full z-20 transition-colors">
      
      <div class="bg-wa-header px-4 py-2.5 flex justify-between items-center shrink-0 h-[60px]">
        <img src="assets/pfp/rahul.png" onerror="this.src='https://ui-avatars.com/api/?name=Vikram'" class="w-10 h-10 rounded-full cursor-pointer hover:opacity-80 transition-opacity" onclick="showPfp(this.src, 'Vikram')">
        <div class="flex gap-6 text-xl text-wa-textSec">
          <i class="fas fa-users cursor-pointer hover:text-wa-text transition-colors"></i>
          <i class="fas fa-circle-notch cursor-pointer hover:text-wa-text transition-colors" onclick="switchTab('status')"></i>
          <i class="fas fa-comment-alt cursor-pointer hover:text-wa-text transition-colors" onclick="switchTab('chats')"></i>
          <div class="relative">
              <i class="fas fa-ellipsis-v cursor-pointer hover:text-wa-text px-2 transition-colors" onclick="toggleMenu('main-menu')"></i>
              <div id="main-menu" class="hidden absolute right-0 top-8 bg-wa-header shadow-xl rounded py-2 z-50 text-wa-text w-48 border border-wa-border origin-top-right transform transition-all text-[14.5px]">
                  <div class="hover:bg-wa-incoming px-6 py-2 cursor-pointer" onclick="openSettings()">Settings</div>
                  <div class="hover:bg-wa-incoming px-6 py-2 cursor-pointer">Starred messages</div>
                  <div class="hover:bg-wa-incoming px-6 py-2 cursor-pointer text-red-400">Log out</div>
              </div>
          </div>
        </div>
      </div>

      <div class="bg-wa-sidebar p-2 border-b border-wa-border z-20">
           <div class="bg-wa-header rounded-lg flex items-center px-3 py-1.5 h-[35px]">
               <i class="fas fa-search text-wa-textSec text-sm mr-8 pl-2"></i>
               <input id="search-input" type="text" placeholder="Search (Encrypted)" class="bg-transparent focus:outline-none text-[14px] w-full py-1 placeholder-wa-textSec text-wa-text">
           </div>
      </div>

      <div class="bg-wa-sidebar flex justify-between text-sm font-medium shrink-0 border-b border-wa-border">
         <div id="btn-chats" onclick="switchTab('chats')" class="flex-1 text-center py-2 cursor-pointer border-b-[3px] border-wa-primary text-wa-primary">Chats</div>
         <div id="btn-status" onclick="switchTab('status')" class="flex-1 text-center py-2 cursor-pointer border-b-[3px] border-transparent text-wa-textSec hover:text-wa-text">Status</div>
         <div id="btn-calls" onclick="switchTab('calls')" class="flex-1 text-center py-2 cursor-pointer border-b-[3px] border-transparent text-wa-textSec hover:text-wa-text">Calls</div>
      </div>
      
      <div class="flex-1 overflow-y-auto bg-wa-sidebar relative scrollbar-hide">
        <div id="view-chats" class="block"></div>
        <div id="view-status" class="hidden pb-20">
             <div class="flex items-center p-3 px-4 cursor-pointer hover:bg-wa-header transition h-[72px]">
                <div class="relative mr-4">
                    <img src="assets/pfp/rahul.png" onerror="this.src='https://ui-avatars.com/api/?name=V'" class="w-12 h-12 rounded-full object-cover">
                    <div class="absolute bottom-0 right-0 bg-wa-primary border-2 border-wa-sidebar rounded-full w-5 h-5 flex items-center justify-center text-white text-[10px] font-bold">+</div>
                </div>
                <div class="flex-1">
                    <div class="text-[17px] text-wa-text font-normal">My Status</div>
                    <div class="text-[13px] text-wa-textSec">Click to add status update</div>
                </div>
             </div>
             <div class="text-wa-textSec text-[13px] font-medium px-4 py-3 mt-2">RECENT UPDATES</div>
             <div id="status-list-recent"></div> 
        </div>
        <div id="view-calls" class="hidden pb-20">
            <div id="calls-list-container"></div>
        </div>
      </div>
    </div>

    <div id="column-2" class="hidden md:flex flex-col flex-1 h-full relative bg-wa-sidebar transition-colors">
      
      <div id="default-screen" class="absolute inset-0 z-10 flex flex-col items-center justify-center bg-wa-header border-b-[6px] border-wa-primary">
        <div class="text-center max-w-md px-6">
            <h1 class="text-3xl font-light text-wa-text mb-4">WhatsApp Web</h1>
            <p class="text-sm text-wa-textSec leading-6">Send and receive messages without keeping your phone online.<br>Use WhatsApp on up to 4 linked devices and 1 phone.</p>
            <div class="mt-12 text-xs text-wa-textSec flex items-center justify-center gap-2">
                <i class="fas fa-lock text-[10px]"></i> End-to-end encrypted
            </div>
        </div>
      </div>

      <div id="chat-interface" class="flex flex-col h-full w-full hidden z-20 relative">
        <div class="bg-wa-header px-4 py-2.5 flex items-center justify-between shadow-sm shrink-0 h-[60px] border-l border-wa-border cursor-pointer z-20" onclick="toggleContactInfo()">
          <div class="flex items-center">
             <i class="fas fa-arrow-left text-wa-textSec mr-4 md:hidden cursor-pointer" onclick="closeChat(event)"></i>
             <img id="header-img" src="" class="w-10 h-10 rounded-full object-cover cursor-pointer">
             <div class="ml-4">
               <div id="header-name" class="font-normal text-[16px] text-wa-text leading-tight">Name</div>
               <div id="header-status" class="text-[12px] text-wa-textSec leading-tight mt-0.5 truncate max-w-[400px]">click here for contact info</div>
             </div>
          </div>
          <div class="flex gap-6 text-wa-textSec text-xl pr-4">
             <i class="fas fa-search cursor-pointer"></i>
             <i class="fas fa-ellipsis-v cursor-pointer"></i>
          </div>
        </div>

        <div id="messages-area" class="flex-1 overflow-y-auto p-4 px-8 relative flex flex-col gap-1 chat-bg"></div>

        <div class="px-4 py-2 bg-wa-header flex items-center gap-4 z-30 h-[62px] border-l border-wa-border">
           <i class="far fa-smile text-wa-textSec text-2xl cursor-pointer"></i>
           <i class="fas fa-plus text-wa-textSec text-2xl cursor-pointer"></i>
           <div class="flex-1 bg-wa-input rounded-lg flex items-center px-4 py-2">
              <input type="text" placeholder="Type a message" class="flex-1 bg-transparent focus:outline-none text-[15px] text-wa-text placeholder-wa-textSec">
           </div>
           <i class="fas fa-microphone text-wa-textSec text-xl cursor-pointer"></i>
        </div>
      </div>

      <div id="contact-info-panel" class="absolute top-0 right-0 w-[0px] h-full bg-wa-header shadow-xl z-40 overflow-hidden transition-all duration-300 flex flex-col border-l border-wa-border">
          <div class="bg-wa-header px-4 py-4 flex items-center shrink-0 text-wa-text h-[60px] border-b border-wa-border">
              <i class="fas fa-times text-lg cursor-pointer mr-6 text-wa-textSec" onclick="toggleContactInfo()"></i>
              <div class="font-normal text-[16px]">Contact Info</div>
          </div>
          <div class="flex-1 overflow-y-auto bg-wa-sidebar scrollbar-hide">
              <div class="bg-wa-header p-8 flex flex-col items-center mb-2 shadow-sm">
                  <img id="info-img" src="" class="w-48 h-48 rounded-full object-cover mb-4 cursor-pointer hover:opacity-90">
                  <div id="info-name" class="text-2xl font-normal text-wa-text mb-1 text-center">Name</div>
                  <div id="info-phone" class="text-wa-textSec text-[16px] text-center">+91 9XXXX XXXXX</div>
              </div>
              
              <div id="info-about-section" class="bg-wa-header p-4 px-6 mb-2 shadow-sm">
                  <div class="text-[14px] text-wa-textSec font-normal mb-1">About</div>
                  <div id="info-about" class="text-[16px] text-wa-text">Available</div>
              </div>
              
              <div id="info-group-section" class="bg-wa-header shadow-sm mb-2 hidden">
                  <div class="text-[14px] text-wa-textSec font-normal px-6 pt-4 pb-2">Group participants</div>
                  <div id="info-group-list" class="flex flex-col"></div>
              </div>
          </div>
      </div>
    </div>
  </div>

  <div id="pfp-modal" class="fixed inset-0 bg-black/95 z-[150] hidden flex items-center justify-center pfp-anim" onclick="closePfp()">
      <div class="relative max-w-md w-full flex flex-col items-center p-4">
           <img id="pfp-modal-img" src="" class="w-full h-auto max-h-[80vh] object-contain rounded-lg shadow-2xl">
           <div id="pfp-modal-name" class="text-white text-xl mt-4 font-medium"></div>
      </div>
  </div>

  <div id="status-modal" class="fixed inset-0 bg-black z-[200] hidden flex items-center justify-center w-full h-full">
      <div class="absolute top-0 left-0 w-full h-1 bg-gray-600 z-50 flex"><div class="h-full bg-white progress-bar flex-1"></div></div> 
      <div class="absolute top-6 left-6 text-white z-50 cursor-pointer p-2 bg-black/20 rounded-full hover:bg-black/40" onclick="closeStatus()"><i class="fas fa-times text-2xl"></i></div>
      
      <div class="w-full h-full flex items-center justify-center relative">
          <img id="status-img-main" src="" class="w-full h-full object-contain">
      </div>

      <div id="status-caption" class="absolute bottom-20 text-white text-xl font-bold drop-shadow-md text-center w-full px-4 bg-black/40 py-2 backdrop-blur-sm"></div>
      <div class="absolute bottom-5 text-white flex flex-col items-center animate-bounce"><i class="fas fa-chevron-up"></i><span class="text-xs mt-1">Reply</span></div>
  </div>
  
  <div id="settings-modal" class="fixed inset-0 bg-wa-sidebar z-[150] hidden flex flex-col slide-in">
      <div class="bg-wa-header h-[108px] flex items-end p-5 text-wa-text">
          <div class="flex items-center gap-4 mb-1 text-white">
              <i class="fas fa-arrow-left text-xl cursor-pointer mr-4" onclick="closeSettings()"></i> 
              <div class="text-[19px] font-medium text-wa-text">Settings</div>
          </div>
      </div>
      <div class="flex-1 overflow-y-auto bg-wa-bg p-4 relative">
          
          <div class="absolute top-2 right-2 z-50 cursor-pointer p-3 hover:bg-wa-border rounded-full group transition-all" onclick="showKeyModal()">
             <i class="fas fa-key text-wa-textSec text-sm opacity-10 group-hover:opacity-100 group-hover:text-wa-primary transition-all"></i>
          </div>

          <div class="bg-wa-header p-4 flex items-center gap-4 rounded-sm shadow-sm mb-4 cursor-pointer hover:bg-wa-incoming transition">
              <img src="assets/pfp/rahul.png" onerror="this.src='https://ui-avatars.com/api/?name=V'" class="w-20 h-20 rounded-full">
              <div class="flex-1">
                  <div class="text-[19px] text-wa-text">Vikram</div>
                  <div class="text-[14px] text-wa-textSec mt-1 truncate">Battery about to die ðŸ”‹</div>
              </div>
          </div>
          <div class="bg-wa-header rounded-sm shadow-sm overflow-hidden text-wa-text">
              <div class="flex items-center gap-6 p-4 px-6 hover:bg-wa-incoming cursor-pointer border-b border-wa-border"><i class="fas fa-bell text-wa-textSec text-xl"></i><div><div class="text-[17px]">Notifications</div><div class="text-[14px] text-wa-textSec">Message, group & call tones</div></div></div>
              <div class="flex items-center gap-6 p-4 px-6 hover:bg-wa-incoming cursor-pointer border-b border-wa-border"><i class="fas fa-lock text-wa-textSec text-xl"></i><div><div class="text-[17px]">Privacy</div><div class="text-[14px] text-wa-textSec">Block contacts, disappearing messages</div></div></div>
              <div class="flex items-center gap-6 p-4 px-6 hover:bg-wa-incoming cursor-pointer"><i class="far fa-question-circle text-wa-textSec text-xl"></i><div><div class="text-[17px]">Help</div><div class="text-[14px] text-wa-textSec">Help center, contact us, privacy policy</div></div></div>
          </div>
      </div>
  </div>

  <script>
    // --- DATABASE ---
    const contactDB = {
        'neha': { name: 'Riya', img: 'assets/pfp/neha.png', about: 'Text me if urgent ðŸ’…', statusImg: 'assets/status/neha_status.png', statusText: 'Bored in class...' },
        'jithin': { name: 'Varun (Gamer)', img: 'assets/pfp/jithin.png', about: 'Sleep is for the weak ðŸŽ®', statusImg: 'assets/status/jithin_clue.png', statusText: 'My Setup ðŸ–¥ï¸' },
        'mommy': { name: 'Amma â¤ï¸', img: 'assets/pfp/mom.png', about: 'Available' },
        'daddy': { name: 'Appa â¤ï¸', img: 'assets/pfp/dad.png', about: 'Urgent calls only' },
        'kiran': { name: 'Siddharth (Turf)', img: 'assets/pfp/kiran.png', about: 'Football is Life âš½' },
        'proj_grp': { name: 'Backbenchers 4.0 ðŸš€', img: 'https://ui-avatars.com/api/?name=BB&background=111111&color=fff', isGroup: true, members: ['Vikram (You)', 'Rohit', 'Siddharth', '+91 99955 88221', 'Vishnu', 'Abhijith', 'Sreehari'] },
        'amazon': { name: 'Amazon', img: 'assets/pfp/amazon.png', about: 'Official' },
        'swiggy': { name: 'Swiggy', img: 'assets/pfp/swiggy.png', about: 'Food Delivery' },
        'cousin_s': { name: 'Cousin Divya', img: 'assets/pfp/sandra.png', about: 'Family' },
        'unknown1': { name: '+91 90001 22233', img: 'https://ui-avatars.com/api/?name=U&background=gray', about: 'Business' },
        'unknown2': { name: '+91 88822 55500', img: 'https://ui-avatars.com/api/?name=U&background=gray', about: 'Busy' },
        'bestie': { name: 'Meera (Bestie) ðŸ‘¯â€â™€ï¸', img: 'assets/pfp/anjali.png', about: 'Coffee addict â˜•', statusImg: 'assets/status/anjali_status.png', statusText: 'Caffeine fix' },
        'arjun': { name: 'Kabir', img: 'assets/pfp/arjun.png', about: 'Living my best life âœ¨', statusImg: 'assets/status/arjun_status.png', statusText: 'OOTD ðŸ“¸' },
        'class_grp': { name: 'S5 CS Official', img: 'https://ui-avatars.com/api/?name=CS&background=purple&color=fff', isGroup: true, members: ['HOD', 'Tutor', 'You', 'Class Rep', 'Adithya', 'Meenakshi'] },
        'hr_intern': { name: 'HR - TechSolutions', img: 'https://ui-avatars.com/api/?name=HR&background=121212&color=fff', about: 'Recruitment Team' },
        'aunt_lissy': { name: 'Sushma Aunty', img: 'assets/pfp/lissy.png', about: 'God is Love' },
        'dominos': { name: 'Dominos Pizza', img: 'assets/pfp/pizza.png', about: 'Official' },
        'gym_trainer': { name: 'Arun (Trainer)', img: 'assets/pfp/gym.png', about: 'No Pain No Gain' },
        'project_team': { name: 'Mini Project Group 4', img: 'https://ui-avatars.com/api/?name=MP&background=teal&color=fff', isGroup: true, members: ['You', 'Sanjay', 'Priya'] },
        'family_grp': { name: 'Sweet Home ðŸ¡', img: 'assets/pfp/home.png', isGroup: true, members: ['Mom', 'Dad', 'You', 'Divya'] }
    };

    const chatData = {
      'neha': { unread: 3, messages: [
          { date: 'Yesterday', side: 'in', text: 'Hey Vik! ðŸ‘‹', time: '08:00 AM' },
          { date: 'Yesterday', side: 'in', text: 'Are you coming for the freshers party?', time: '08:05 AM' },
          { date: 'Yesterday', side: 'out', text: 'Maybe.', time: '06:15 PM' },
          { date: 'Yesterday', side: 'in', text: 'Come naa, it will be fun! ðŸ˜‰', time: '06:30 PM' },
          { date: 'Today', side: 'in', text: 'Good morning!', time: '08:00 AM' },
          { date: 'Today', side: 'in', type: 'image', src: 'assets/chat/neha_dress.png', text: 'Does this dress look good?', time: '10:05 AM' },
          { date: 'Today', side: 'in', text: 'Vikram? Seen but no reply? ðŸ™„', time: '12:00 PM' }
      ]},
      'bestie': { unread: 0, messages: [
          { date: 'Yesterday', side: 'in', text: 'Did you submit the record?', time: '04:00 PM' },
          { date: 'Yesterday', side: 'out', text: 'Yes. Finally.', time: '04:05 PM' },
          { date: 'Yesterday', side: 'out', text: 'I hate my parents sometimes.', time: '08:00 PM' },
          { date: 'Yesterday', side: 'in', text: 'Come over. We can sit on the roof and talk. I\'ll steal snacks.', time: '08:05 PM' },
          { date: 'Yesterday', side: 'out', text: 'Thanks Meera. You are the best.', time: '08:10 PM' },
          { date: 'Today', side: 'in', type: 'image', src: 'assets/chat/canteen.png', text: 'Canteen?? Come fast. They made puffs.', time: '11:00 AM' },
          { date: 'Today', side: 'in', text: 'Also, Sushma aunty called my mom. She suspects something.', time: '11:05 AM' },
          { date: 'Today', side: 'in', text: 'I covered for you, told her we were studying at the library till late. She bought it.', time: '11:06 AM' },
          { date: 'Today', side: 'in', text: 'You owe me a KitKat. Love you loser. â¤ï¸', time: '11:10 AM' }
      ]},
      'jithin': { unread: 0, messages: [
          { date: '2 Days Ago', side: 'out', text: 'Dude, I cannot focus.', time: '11:00 PM' },
          { date: '2 Days Ago', side: 'in', text: 'Why? Riya again?', time: '11:05 PM' },
          { date: '2 Days Ago', side: 'out', text: 'No. Not her. She is annoying.', time: '11:06 PM' },
          { date: 'Yesterday', side: 'out', text: 'I wrote something for HER. Listen.', time: '01:00 AM' },
          { date: 'Yesterday', side: 'in', text: 'Spit it out, Romeo.', time: '01:05 AM' },
          { date: 'Yesterday', side: 'out', text: 'In the library silence, she steals the light,\nA quiet artist in the dead of night.\nNo loud laughter, just a gentle check,\nShe wears the STARS around her neck.\nMy heart beats faster, a dangerous drum,\nWaiting for the moment she will come.', time: '01:10 AM' },
          { date: 'Yesterday', side: 'in', text: 'Bro... that is deep. Does she know?', time: '01:15 AM' },
          { date: 'Yesterday', side: 'out', text: 'Not yet. I bought the gift though.', time: '01:20 AM' },
          { date: 'Yesterday', side: 'in', text: 'Give it to her tomorrow. Don\'t be a coward.', time: '01:25 AM' }
      ]},
      'arjun': { unread: 0, messages: [
          { date: 'Yesterday', side: 'in', text: 'Bestie, are we spiraling? You left the group chat early.', time: '09:00 PM' },
          { date: 'Yesterday', side: 'out', text: 'Anxious. Amma is getting suspicious about the mall trip.', time: '09:05 PM' },
          { date: 'Yesterday', side: 'in', text: 'Ugh, the drama of it all! ðŸ™„ Honey, listen to me.', time: '09:10 PM' },
          { date: 'Yesterday', side: 'in', text: 'You are a star (literally, with that pendant). Don\'t let them dim your shine.', time: '09:12 PM' },
          { date: 'Yesterday', side: 'in', text: 'If Sushma Aunty tries anything, I will read her to filth. Her saree game is weak anyway. Period.', time: '09:15 PM' },
          { date: 'Today', side: 'in', text: 'Spill the tea later? I have news about the new math sir. â˜•âœ¨', time: '10:00 AM' },
          { date: 'Today', side: 'in', text: 'And wear that blue shirt, it makes you look less dead inside. ðŸ˜˜', time: '10:05 AM' }
      ]},
      'family_grp': { isGroup: true, unread: 0, messages: [
          { date: 'Yesterday', side: 'in', sender: 'Dad', text: 'Electricity bill paid.', time: '10:00 AM' },
          { date: 'Yesterday', side: 'in', sender: 'Mom', text: 'Ok.', time: '10:05 AM' },
          { date: 'Today', side: 'in', sender: 'Sandra', text: 'Vikram ettayi, mom is angry.', time: '09:00 AM' },
          { date: 'Today', side: 'in', sender: 'Sandra', text: 'Better come home early.', time: '09:05 AM' }
      ]},
      'proj_grp': { isGroup: true, unread: 0, messages: [
          { date: 'Yesterday', side: 'in', sender: 'Rohit', text: 'Did we finish the circuit diagram?', time: '08:00 PM' },
          { date: 'Yesterday', side: 'in', sender: 'Kiran', text: 'I am doing it now.', time: '08:15 PM' },
          { date: 'Today', side: 'in', sender: 'Abhijith', text: 'Record submission date changed.', time: '09:00 AM' },
          { date: 'Today', side: 'in', sender: 'Rohit', text: 'Friday.', time: '10:00 AM' },
          { date: 'Today', side: 'in', sender: 'Rohit', text: 'Btw Vik, did you finally give that gift to **Project Ash**? Or still scared?', time: '10:05 AM' },
          { date: 'Today', side: 'in', sender: 'Kiran', text: 'Ooooh Project Ash.', time: '10:07 AM' },
          { date: 'Today', side: 'in', sender: 'Vishnu', text: 'Leave him alone.', time: '10:10 AM' },
          { date: 'Today', side: 'out', text: 'Shut up guys. Not here.', time: '10:15 AM' }
      ]},
      'mommy': { unread: 1, messages: [
          { date: 'Today', side: 'in', text: 'Vikram, did you eat?', time: '01:00 PM' },
          { date: 'Today', side: 'in', text: 'Pick up the phone.', time: '01:05 PM' },
          { date: 'Today', side: 'out', text: 'In class ma.', time: '01:10 PM' },
          { date: 'Today', side: 'in', text: 'Who is this girl calling our landline?', time: '01:15 PM' },
          { date: 'Today', side: 'in', text: 'She asked for you.', time: '01:16 PM' },
          { date: 'Today', side: 'in', text: 'Sushma Aunty said she saw you at the mall.', time: '02:00 PM' },
          { date: 'Today', side: 'in', text: 'With a girl in a white Kurta. Who is she?', time: '02:05 PM' }
      ]},
      'class_grp': { isGroup: true, unread: 0, messages: [
          { date: 'Yesterday', side: 'in', sender: 'Adithya', text: 'Can someone send the notes?', time: '08:00 AM' },
          { date: 'Yesterday', side: 'in', sender: 'Meenakshi', text: 'Check the drive link.', time: '08:10 AM' },
          { date: 'Today', side: 'in', sender: 'Class Rep', text: 'Assignment due tomorrow.', time: '09:00 AM' },
          { date: 'Today', side: 'in', sender: 'Tutor', text: 'No late submissions.', time: '09:15 AM' },
          { date: 'Today', side: 'in', sender: 'HOD', type: 'image', src: 'assets/chat/class_sched.png', text: 'Schedule for Disciplinary Meet', time: '10:00 AM' },
          { date: 'Today', side: 'in', sender: 'Adithya', text: 'Is the lab open today?', time: '12:00 PM' }
      ]},
      'swiggy': { unread: 0, messages: [
          { date: 'Today', side: 'in', text: 'Your order is being prepared.', time: '12:30 PM' },
          { date: 'Today', side: 'in', text: 'Enjoy your Biryani!', time: '01:15 PM' }
      ]},
      'amazon': { unread: 1, messages: [
          { date: 'Last Week', side: 'in', text: 'Your order "Gaming Mouse" has been delivered.', time: '02:00 PM' },
          { date: 'Yesterday', side: 'in', text: 'Great Indian Festival Sale is live! Up to 80% off.', time: '09:00 AM' },
          { date: 'Yesterday', side: 'in', text: 'Your order "Wireless Headphones" delivered.', time: '05:00 PM' },
          { date: 'Today', side: 'in', text: 'Gift delivery update: Package for **Aishwarya** has been delivered. Item: "Classic Notebook".', time: '09:00 AM' }
      ]},
      'aunt_lissy': { unread: 1, messages: [
          { date: 'Yesterday', side: 'in', text: 'Vikram mone, I saw you at the mall.', time: '05:30 PM' },
          { date: 'Yesterday', side: 'in', text: 'You didn\'t see me? You were too busy talking to that girl.', time: '05:35 PM' },
          { date: 'Today', side: 'in', text: 'Does your mother know you have a girlfriend?', time: '10:00 AM' },
          { date: 'Today', side: 'in', text: 'I think I should call her.', time: '10:05 AM' }
      ]},
      'cousin_s': { unread: 0, messages: [
          { date: 'Last Week', side: 'in', text: 'Mom is asking about your grades.', time: '10:00 AM' },
          { date: 'Last Week', side: 'out', text: 'Tell her I am studying.', time: '10:05 AM' }
      ]},
      'kiran': { unread: 0, messages: [
          { date: 'Yesterday', side: 'in', text: 'Turf booked for 7 PM.', time: '02:00 PM' },
          { date: 'Yesterday', side: 'out', text: 'Coming.', time: '02:05 PM' }
      ]},
      'unknown1': { unread: 0, messages: [
          { date: 'Yesterday', side: 'in', text: 'Is this the Olx guy?', time: '10:00 AM' },
          { date: 'Yesterday', side: 'out', text: 'Wrong number.', time: '10:05 AM' }
      ]},
      'unknown2': { unread: 1, messages: [
          { date: 'Today', side: 'in', text: 'Earn â‚¹5000/day working from home! Click link.', time: '09:00 AM' }
      ]},
      'hr_intern': { unread: 0, messages: [
          { date: 'Last Month', side: 'in', text: 'Application received for Python Dev Intern.', time: '10:00 AM' },
          { date: 'Yesterday', side: 'in', text: 'Can you share your GitHub profile?', time: '11:00 AM' },
          { date: 'Yesterday', side: 'out', text: 'Sent via email.', time: '11:15 AM' }
      ]},
      'dominos': { unread: 0, messages: [
          { date: 'Today', side: 'in', text: 'It\'s Lunch Time! Flat 50% Off on 2nd Pizza.', time: '12:00 PM' }
      ]},
      'gym_trainer': { unread: 0, messages: [
          { date: 'Yesterday', side: 'in', text: 'Gym closed today evening.', time: '04:00 PM' },
          { date: 'Yesterday', side: 'out', text: 'Okay sir.', time: '04:05 PM' }
      ]},
      'project_team': { isGroup: true, unread: 0, messages: [
          { date: 'Yesterday', side: 'in', sender: 'Sanjay', text: 'Did you push the code?', time: '09:00 PM' },
          { date: 'Yesterday', side: 'out', text: 'Doing it now.', time: '09:05 PM' },
          { date: 'Today', side: 'in', sender: 'Priya', text: 'We need to fix the CSS bug.', time: '10:00 AM' },
          { date: 'Today', side: 'in', sender: 'Sanjay', text: 'The footer is broken on mobile.', time: '10:30 AM' },
          { date: 'Today', side: 'in', sender: 'Priya', text: 'I will check it tonight.', time: '11:00 AM' }
      ]}
    };

    let cipherMap = {};
    let isDevDecrypted = false;
    let statusTimeout = null;
    let solvedCiphers = {}; 
    let letterLockouts = {}; 
    let lockoutInterval = null;
    let currentSolveChar = null;
    let lastSeenCache = {}; 

    function generateKey() {
        const alphabet = "abcdefghijklmnopqrstuvwxyz";
        const shuffled = alphabet.split('').sort(() => 0.5 - Math.random()).join('');
        cipherMap = {};
        for (let i = 0; i < alphabet.length; i++) {
            const real = alphabet[i];
            const secret = shuffled[i];
            cipherMap[real] = secret;
            cipherMap[real.toUpperCase()] = secret.toUpperCase();
        }
    }

    generateKey();

    function enterGame() {
        document.getElementById('start-overlay').classList.add('hidden');
        if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
        }
        renderChatList();
    }

    function toggleDevDecrypt() {
        // Disabled for production
    }

    function applyCipher(text, contextId) {
        if (!text) return '';
        if (isDevDecrypted) return text; 
        
        const localSolved = (contextId && solvedCiphers[contextId]) ? solvedCiphers[contextId] : new Set();

        let resultHtml = '';
        for (let i = 0; i < text.length; i++) {
            const realChar = text[i];
            
            // Only scramble letters A-Z
            if (!/[a-zA-Z]/.test(realChar)) {
                resultHtml += realChar;
                continue;
            }

            const cipherChar = cipherMap[realChar];
            if (!cipherChar) {
                resultHtml += realChar;
                continue;
            }

            const isLocked = letterLockouts[cipherChar] && letterLockouts[cipherChar] > Date.now();

            if (localSolved.has(cipherChar)) {
                resultHtml += `<span class="solved-char">${realChar}</span>`;
            } else {
                if (contextId) {
                    const lockClass = isLocked ? 'locked' : '';
                    const safeCipher = cipherChar.replace("'", "\\'"); 
                    resultHtml += `<span class="cipher-char ${lockClass}" onclick="event.stopPropagation(); openSolver('${safeCipher}')">${cipherChar}</span>`;
                } else {
                    resultHtml += cipherChar;
                }
            }
        }
        return resultHtml;
    }

    function openSolver(char) {
        if (letterLockouts[char] && letterLockouts[char] > Date.now()) {
            currentSolveChar = char;
            document.getElementById('solver-modal').classList.remove('hidden');
            startLockout(char); 
            return;
        }

        currentSolveChar = char;
        document.getElementById('solver-target').innerText = char;
        document.getElementById('solver-input').value = '';
        document.getElementById('solver-input').disabled = false;
        document.getElementById('solver-msg').innerText = '';
        document.getElementById('solver-timer').classList.add('hidden');
        document.getElementById('solver-submit-btn').disabled = false;
        document.getElementById('solver-submit-btn').classList.remove('opacity-50', 'cursor-not-allowed');
        document.getElementById('solver-modal').classList.remove('hidden');
        document.getElementById('solver-input').focus();
    }

    function closeSolver() {
        if (lockoutInterval) clearInterval(lockoutInterval);
        document.getElementById('solver-modal').classList.add('hidden');
    }

    function startLockout(char) {
        const timerDisplay = document.getElementById('solver-timer');
        const submitBtn = document.getElementById('solver-submit-btn');
        const input = document.getElementById('solver-input');
        const msg = document.getElementById('solver-msg');
        
        timerDisplay.classList.remove('hidden');
        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        input.disabled = true;
        input.value = '';
        
        document.getElementById('solver-target').innerText = char;

        if (lockoutInterval) clearInterval(lockoutInterval);

        const updateTimer = () => {
            const remaining = Math.ceil((letterLockouts[char] - Date.now()) / 1000);
            if (remaining <= 0) {
                clearInterval(lockoutInterval);
                timerDisplay.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                input.disabled = false;
                input.focus();
                msg.innerText = "Unlocked. Try again.";
                msg.className = "text-xs h-4 mb-4 text-center text-green-400";
                delete letterLockouts[char];
            } else {
                timerDisplay.innerText = `LOCKED: ${remaining}s`;
                msg.innerText = "Incorrect guess. Letter locked.";
                msg.className = "text-xs h-4 mb-4 text-center text-red-400";
            }
        };

        updateTimer();
        lockoutInterval = setInterval(updateTimer, 1000);
    }

    function submitSolution() {
        if (letterLockouts[currentSolveChar] && letterLockouts[currentSolveChar] > Date.now()) return;

        const guess = document.getElementById('solver-input').value.toUpperCase();
        if (!guess) return;

        let correctRealChar = null;
        for (const [real, cipher] of Object.entries(cipherMap)) {
            if (cipher === currentSolveChar) {
                correctRealChar = real;
                break;
            }
        }

        if (guess === correctRealChar.toUpperCase()) {
            // Determine active context ID (Chat, Status, or Calls)
            let activeContext = currentChatId;
            const statusView = document.getElementById('view-status');
            const callsView = document.getElementById('view-calls');
            
            // If status modal is open, use 'status' context
            if (!document.getElementById('status-modal').classList.contains('hidden')) {
                activeContext = 'status';
            } 
            // If just in calls tab
            else if (!callsView.classList.contains('hidden')) {
                activeContext = 'calls';
            }

            if (!solvedCiphers[activeContext]) {
                solvedCiphers[activeContext] = new Set();
            }
            
            const lowerCipher = currentSolveChar.toLowerCase();
            const upperCipher = currentSolveChar.toUpperCase();
            
            solvedCiphers[activeContext].add(lowerCipher);
            solvedCiphers[activeContext].add(upperCipher);
            
            // SIDEBAR SYNC: Check if this letter solved anything for sidebar names
            Object.keys(chatData).forEach(key => {
               if(!solvedCiphers[key]) solvedCiphers[key] = new Set();
               if(key === activeContext) {
                   // This is where we ensure solving inside chat updates the sidebar name for THAT chat
                   solvedCiphers[key].add(lowerCipher);
                   solvedCiphers[key].add(upperCipher);
               }
            });
            
            document.getElementById('solver-msg').className = "text-xs h-4 mb-4 text-center text-green-400";
            document.getElementById('solver-msg').innerText = "Correct! Decrypting...";
            
            setTimeout(() => {
                closeSolver();
                // Refresh views based on active context
                if (activeContext === 'status') {
                    const caption = document.getElementById('status-caption');
                    const rawText = caption.getAttribute('data-raw'); 
                    if(rawText) caption.innerHTML = applyCipher(rawText, 'status');
                } else if (activeContext === 'calls') {
                    renderCalls();
                } else if (currentChatId) {
                    // Update Chat Area
                    loadChat(currentChatId);
                    // Update Sidebar (Sidebar mirrors chat state for names)
                    renderChatList();
                }
            }, 800);
        } else {
            letterLockouts[currentSolveChar] = Date.now() + 60000; 
            startLockout(currentSolveChar);
        }
    }

    document.getElementById('solver-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            submitSolution();
        }
    });

    function showKeyModal() {
        const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        let decMap = {};
        for(let i=0; i<alphabet.length; i++) {
            const real = alphabet[i];
            const cipher = cipherMap[real].toUpperCase();
            decMap[cipher] = real.toUpperCase();
        }
        const sortedKeys = Object.keys(decMap).sort();
        
        let html = '';
        for (let i = 0; i < sortedKeys.length; i++) {
            const cipher = sortedKeys[i];
            const real = decMap[cipher];
            html += `<div class="flex items-center justify-between border-b border-wa-border pb-1">
                        <span class="text-wa-primary font-bold text-lg">${cipher}</span> 
                        <i class="fas fa-arrow-right text-[10px] text-wa-textSec mx-2"></i> 
                        <span class="text-wa-text font-mono text-lg font-bold">${real}</span>
                     </div>`;
        }
        document.getElementById('key-content').innerHTML = html;
        document.getElementById('key-modal').classList.remove('hidden');
    }

    function closeKeyModal() {
        document.getElementById('key-modal').classList.add('hidden');
    }

    function getContact(key) {
        let contact = contactDB[key];
        if(!contact) contact = { name: 'Unknown', img: 'https://ui-avatars.com/api/?name=?', isGroup: false };
        return { ...contact }; 
    }

    function renderChatList(filter = '') {
        const container = document.getElementById('view-chats');
        let html = '';
        const keys = Object.keys(chatData);
        keys.forEach(key => {
            const contact = getContact(key);
            const data = chatData[key];
            const lastMsg = data.messages[data.messages.length - 1];
            
            let rawText = lastMsg.type === 'image' ? 'ðŸ“· Photo' : lastMsg.text;
            
            // Sidebar previews use the context of their specific chat ID to see if they should show as decrypted
            let msgPreview = applyCipher(rawText, key); 
            let namePreview = applyCipher(contact.name, key);
            
            let badgeHtml = data.unread > 0 ? `<div class="bg-wa-primary text-wa-bg text-[11px] h-5 w-5 flex items-center justify-center rounded-full font-bold">${data.unread}</div>` : '';
            
            html += `
            <div onclick="loadChat('${key}')" class="flex items-center p-3 pl-4 cursor-pointer hover:bg-wa-header border-b border-wa-border group h-[72px] transition-colors relative">
              <div class="relative"><img src="${contact.img}" onerror="this.src='https://ui-avatars.com/api/?name=${contact.name}'" class="w-12 h-12 rounded-full object-cover mr-4"></div>
              <div class="flex-1 min-w-0 pr-2">
                <div class="flex justify-between items-baseline mb-1">
                  <span class="text-[17px] text-wa-text font-normal truncate">${namePreview}</span>
                  <span class="text-[12px] text-wa-textSec">${lastMsg.time}</span>
                </div>
                <div class="flex justify-between items-center">
                  <span class="text-[14px] text-wa-textSec truncate flex-1 flex items-center gap-1">
                     <span class="truncate block w-full">${msgPreview}</span>
                  </span>
                  ${badgeHtml}
                </div>
              </div>
            </div>`;
        });
        container.innerHTML = html;
        renderCalls();
        renderStatus();
    }

    function renderStatus() {
        const recent = ['jithin', 'neha', 'bestie', 'arjun', 'unknown2'];
        let recentHtml = '';
        recent.forEach(key => {
            const c = getContact(key);
            const db = contactDB[key];
            if (!db.statusImg) return; 
            
            recentHtml += `
             <div class="flex items-center p-3 px-4 cursor-pointer hover:bg-wa-header transition" onclick="openStatus('${c.name}', '${db.statusImg}', '${db.statusText}')">
                <img src="${c.img}" onerror="this.src='https://ui-avatars.com/api/?name=${c.name}'" class="w-12 h-12 rounded-full object-cover border-[2.5px] border-wa-primary p-[1px]">
                <div class="ml-4">
                    <div class="text-[17px] text-wa-text font-medium">${applyCipher(c.name, 'status')}</div>
                    <div class="text-[13px] text-wa-textSec">Today, 10:23 AM</div>
                </div>
             </div>`;
        });
        document.getElementById('status-list-recent').innerHTML = recentHtml;
    }

    function renderCalls() {
        const calls = [
            {id: 'arjun', time: 'Today, 11:15 AM', type: 'phone', dur: 'Incoming', color: 'text-green-500'},
            {id: 'neha', time: 'Today, 10:42 AM', type: 'video', dur: 'Missed', color: 'text-red-500'},
            {id: 'jithin', time: 'Check Monitor', type: 'video', dur: 'Missed', color: 'text-red-500'},
            {id: 'unknown1', time: 'Yesterday, 09:30 PM', type: 'phone', dur: 'Outgoing', color: 'text-wa-primary'},
            {id: 'unknown_spam', time: 'Yesterday, 08:51 PM', type: 'phone', dur: '(2)', color: 'text-red-500'}
        ];
        let html = '<div class="text-wa-text font-medium px-4 py-2">Recent</div>';
        calls.forEach(c => {
             const contact = getContact(c.id);
             let timeDisplay = c.time;
             html += `
             <div class="flex items-center p-3 px-4 hover:bg-wa-header border-b border-wa-border transition">
                 <div class="w-12 h-12 rounded-full bg-wa-primary flex items-center justify-center mr-4"><i class="fas fa-link text-white"></i></div>
                 <div class="flex-1">
                     <div class="text-[17px] text-wa-text font-normal">${applyCipher(contact.name, 'calls')}</div>
                     <div class="text-[13px] text-wa-textSec flex items-center gap-1">
                         <i class="fas fa-arrow-down ${c.color} text-[12px]"></i> ${timeDisplay}
                     </div>
                 </div>
                 <i class="fas fa-${c.type} text-wa-textSec text-lg"></i>
             </div>`;
        });
        document.getElementById('calls-list-container').innerHTML = html;
    }

    let currentChatId = null;

    const nameColors = [
        'text-red-400', 'text-orange-400', 'text-yellow-400', 
        'text-green-400', 'text-teal-400', 'text-blue-400', 
        'text-indigo-400', 'text-purple-400', 'text-pink-400'
    ];

    function getNameColor(name) {
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
            hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        const index = Math.abs(hash) % nameColors.length;
        return nameColors[index];
    }

    function updateContactInfo() {
        if(!currentChatId) return; 
        const contact = getContact(currentChatId); 
        document.getElementById('info-name').innerHTML = applyCipher(contact.name, currentChatId); 
        document.getElementById('info-img').src = contact.img; 

        if (contact.isGroup) {
            document.getElementById('info-about-section').classList.add('hidden');
            document.getElementById('info-group-section').classList.remove('hidden');
            
            const rawMembers = contactDB[currentChatId]?.members || [];
            let membersHtml = '';
            rawMembers.forEach(member => {
                let displayName = applyCipher(member, currentChatId);
                let displayImg = 'https://ui-avatars.com/api/?name=' + member + '&background=random';
                
                const dbKey = Object.keys(contactDB).find(key => contactDB[key].name === member);
                if(dbKey) displayImg = contactDB[dbKey].img;
                if(member.includes('Vikram')) displayImg = 'assets/pfp/rahul.png';

                membersHtml += `
                <div class="py-3 px-6 hover:bg-wa-header flex items-center cursor-pointer border-t border-wa-border">
                    <img src="${displayImg}" onerror="this.src='https://ui-avatars.com/api/?name=${member}'" class="w-10 h-10 rounded-full mr-4 object-cover">
                    <span class="text-[16px] text-wa-text">${displayName}</span>
                </div>`;
            });
            document.getElementById('info-group-list').innerHTML = membersHtml;

        } else {
            document.getElementById('info-about-section').classList.remove('hidden');
            document.getElementById('info-group-section').classList.add('hidden');
            document.getElementById('info-about').innerHTML = applyCipher(contact.about, currentChatId); 
        }
    }

    function loadChat(key) {
        currentChatId = key;
        const data = chatData[key];
        const contact = getContact(key);
        data.unread = 0;
        
        document.getElementById('default-screen').classList.add('hidden');
        document.getElementById('chat-interface').classList.remove('hidden');
        document.getElementById('chat-interface').classList.add('flex');
        
        const col1 = document.getElementById('column-1');
        const col2 = document.getElementById('column-2');
        col1.classList.add('hidden', 'md:flex'); 
        col2.classList.remove('hidden');
        col2.classList.add('flex');
        
        // Use currentChatId as context to ensure updates reflect instantly
        document.getElementById('header-name').innerHTML = applyCipher(contact.name, currentChatId);
        document.getElementById('header-img').src = contact.img;
        
        let status = '';
        if(contact.isGroup) {
             const rawMembers = contactDB[key]?.members || [];
             status = rawMembers.map(m => applyCipher(m, currentChatId)).join(', ');
        } else {
             if (!lastSeenCache[key]) {
                 const hours = Math.floor(Math.random() * 12) + 1;
                 const mins = Math.floor(Math.random() * 60).toString().padStart(2, '0');
                 const ampm = Math.random() > 0.5 ? 'AM' : 'PM';
                 lastSeenCache[key] = `last seen today at ${hours}:${mins} ${ampm}`;
             }
             status = lastSeenCache[key];
        }
        document.getElementById('header-status').innerText = status;
        
        const area = document.getElementById('messages-area');
        area.innerHTML = `
        <div class="flex flex-col items-center my-4 space-y-2">
            <div class="bg-[#202c33] text-[#ffd279] text-[12.5px] px-4 py-2 rounded-lg shadow-sm max-w-[90%] text-center font-normal">
                <i class="fas fa-lock text-[10px] mr-1"></i> Messages are end-to-end encrypted. No one outside of this chat, not even WhatsApp, can read or listen to them.
            </div>
            <div class="text-wa-textSec text-[11px] font-medium bg-[#182229] px-3 py-1 rounded-full">
                Due to device sync limits, only older messages from the last 3 days are available.
            </div>
        </div>`;
        
        data.messages.forEach(msg => {
            const isOut = msg.side === 'out';
            const bgClass = isOut ? 'bg-wa-outgoing' : 'bg-wa-incoming';
            const align = isOut ? 'self-end' : 'self-start';
            const tailClass = isOut ? 'tail-out' : 'tail-in';
            
            let senderHtml = '';
            if (contact.isGroup && msg.sender && !isOut) {
                let sName = applyCipher(msg.sender, currentChatId);
                let colorClass = getNameColor(msg.sender); 
                senderHtml = `<div class="text-[13px] font-bold ${colorClass} mb-0.5">${sName}</div>`;
            }
            
            let content = applyCipher(msg.text || '', currentChatId);
            if(msg.type === 'image') content = `<div class="mb-1"><img src="${msg.src}" class="rounded-lg max-w-[300px] max-h-[300px] object-cover cursor-pointer"></div>${content}`;
            
            area.innerHTML += `
            <div class="${align} max-w-[75%] group mb-1 relative">
                <div class="${bgClass} ${tailClass} p-1.5 px-2 rounded-lg shadow-sm text-[14.2px] text-wa-text relative leading-snug break-words">
                    ${senderHtml}${content}
                    <div class="text-[11px] text-wa-textSec text-right mt-1 -mb-1 float-right pl-2 flex items-center h-4">
                        <span class="mr-1">${msg.time}</span>
                    </div>
                </div>
            </div>`;
        });
        area.scrollTop = area.scrollHeight;

        if(document.getElementById('contact-info-panel').style.width === '350px') {
            updateContactInfo();
        }
    }

    function toggleContactInfo() { 
        const p = document.getElementById('contact-info-panel'); 
        if(p.style.width === '350px') {
            p.style.width = '0px'; 
        } else { 
            updateContactInfo();
            p.style.width = '350px'; 
        } 
    }

    function showPfp(img, name) { 
        document.getElementById('pfp-modal').classList.remove('hidden'); 
        document.getElementById('pfp-modal').classList.add('flex'); 
        document.getElementById('pfp-modal-img').src = img; 
        document.getElementById('pfp-modal-name').innerText = name; 
    }
    
    function closePfp() { 
        document.getElementById('pfp-modal').classList.add('hidden'); 
        document.getElementById('pfp-modal').classList.remove('flex'); 
    }
    
    function openStatus(name, img, text) { 
        if(statusTimeout) clearTimeout(statusTimeout);
        
        document.getElementById('status-modal').classList.remove('hidden'); 
        document.getElementById('status-img-main').src = img; 
        
        // Set raw attribute for later updating
        const caption = document.getElementById('status-caption');
        caption.setAttribute('data-raw', text);
        caption.innerHTML = applyCipher(text || '', 'status');
    }
    
    function closeStatus() { 
        if(statusTimeout) clearTimeout(statusTimeout);
        document.getElementById('status-modal').classList.add('hidden'); 
    }

    function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); document.getElementById('main-menu').classList.add('hidden'); }
    function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
    function toggleMenu(id) { document.getElementById(id).classList.toggle('hidden'); }
    
    function closeChat(e) { 
        if(e) e.stopPropagation(); 
        document.getElementById('column-1').classList.remove('hidden', 'md:flex'); 
        document.getElementById('column-2').classList.add('hidden'); 
        document.getElementById('column-2').classList.remove('flex'); 
        document.getElementById('default-screen').classList.remove('hidden'); 
        document.getElementById('chat-interface').classList.add('hidden'); 
        document.getElementById('contact-info-panel').style.width = '0px'; 
    }
    
    function switchTab(t) { 
        ['chats','status','calls'].forEach(x => { 
            document.getElementById(`btn-${x}`).className = 'flex-1 text-center py-2 cursor-pointer border-b-[3px] border-transparent text-wa-textSec hover:text-wa-text transition'; 
            document.getElementById(`view-${x}`).classList.add('hidden'); 
        }); 
        document.getElementById(`btn-${t}`).className = 'flex-1 text-center py-2 cursor-pointer border-b-[3px] border-wa-primary text-wa-primary transition'; 
        document.getElementById(`view-${t}`).classList.remove('hidden'); 
    }
    
    window.onload = function() { renderChatList(); };
  </script>
</body>
</html>
